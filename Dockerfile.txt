# Usa la imagen oficial de .NET 8 para build
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build

WORKDIR /app

# Copia todo el contenido del repositorio al contenedor
COPY . ./

# Restaura dependencias
RUN dotnet restore "Persistence.ApiRest/Persistence.ApiRest.csproj"

# Publica la app en modo release
RUN dotnet publish "Persistence.ApiRest/Persistence.ApiRest.csproj" -c Release -o /app/publish

# Imagen final con runtime más liviano
FROM mcr.microsoft.com/dotnet/aspnet:8.0

WORKDIR /app

COPY --from=build /app/publish .

# Usa el puerto que Railway asigna
ENV ASPNETCORE_URLS=http://+:${PORT}

# Expón el puerto para Railway (aunque es simbólico, lo ayuda a detectar que se trata de una web app)
EXPOSE 8080

ENTRYPOINT ["dotnet", "Persistence.ApiRest.dll"]
